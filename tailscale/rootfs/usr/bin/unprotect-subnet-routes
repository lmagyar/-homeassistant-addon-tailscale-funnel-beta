#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# In case of non userspace networking,
# remove local subnets from ip rules
# ==============================================================================

declare -a routes=()
declare route family

if bashio::config.false "userspace_networking"; then
  if [[ "$1" != "" ]]; then
    bashio::log.info "Connectivity state changed to $1"
  fi
  # PREVIOUS_SUBNET_ROUTE_PROTECTION_STATE is in contenv at /var/run/s6/container_environment
  if [[ "$PREVIOUS_SUBNET_ROUTE_PROTECTION_STATE" != "" ]]; then
    readarray -t routes < <( \
      { ip -4 rule list; ip -6 rule list; } \
      | { grep -E '^5002:' || true ;} \
      | sed -nr 's/^\d+:\s+from all to ([^\s]+) lookup main$/\1/p')
    for route in "${routes[@]}"; do
      bashio::log.info "Removing route ${route} from ip rules"
      if [[ "${route}" =~ .*:.* ]]; then
        family="-6"
      else
        family="-4"
      fi
      ip "${family}" rule del to "${route}"
    done
    printf "" > /var/run/s6/container_environment/PREVIOUS_SUBNET_ROUTE_PROTECTION_STATE
  fi
fi
