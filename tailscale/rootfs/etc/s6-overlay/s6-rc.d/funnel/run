#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Community Add-on: Tailscale
# Enables Tailscale Funnel feature
# ==============================================================================

declare https_port

https_port=$(bashio::addon.port 443)

# Check if HTTPS port is configured properly
if ! bashio::var.has_value "${https_port}"; then
  bashio::log.error "No HTTPS port is configured"
  bashio::exit.nok
fi

# Check if Tailscale HTTPS is enabled
if ! /opt/tailscale status --self=true --peers=false --json \
  | jq -rce '.Self.CapMap | has("https")' > /dev/null;
then
  bashio::log.error "Tailscale's HTTPS support is disabled"
  bashio::exit.nok
fi

# Check if Funnel is available
if ! /opt/tailscale status --self=true --peers=false --json \
  | jq -rce '.Self.CapMap | has("funnel")' > /dev/null;
then
  bashio::log.error "Tailscale's Funnel support is disabled"
  bashio::exit.nok
fi

# Set up funnel
exec /opt/tailscale funnel --https=${https_port} --set-path=/ "http://127.0.0.1:$(bashio::core.port)"
